---
title: "Demand and Capacity metrics and associations with performance"
format: html
editor: visual
execute: 
  echo: false
---

## Introduction and aims

The aims of this project are to use publicly available data to find associations between performance within Integrated Care Systems, and different demand and capacity metrics.

The strong associations can then be explored as to whether there are actions that can be taken to improve performance.

### Project aims

A summary of the aims of the project (which will need refining over time!):

-   Identify associations between metrics that affect performance
-   Enable long term decision making
-   Forecast future performance based on different scenarios
-   Open source and reproducible code

## Data description

An approximate model of how demand and capacity metrics can be seen below:

![Approximate schematic of relationships between demand and capacity and performance](d_and_c_schematic.png)

```{r}
#| message: false
#| label: source-scripts

source(here::here("R/00_libraries.R"))
source(here::here("R/01_utils.R"))
```

```{r}
#| label: collate-data

dc_data <- list.files(
  here::here("data"), 
  full.names = TRUE
  ) |> 
  (\(x) x[!grepl("configuration-table", x)])() |> 
  purrr::map_dfr(
    # ~ read.csv(.x, encoding = "latin1")
    read.csv
  ) |> 
  select(
    "metric",
    "year", "quarter", "month", "frequency",
    "org", "org_name", 
    "numerator", "denominator", "value"
  ) |> 
  mutate(
    across(
      c(year, quarter, month),
      as.integer
    )
  )

```

### Challenges

There are some challenges in standardising the publicly available data. Data are published for different geographies, at different frequencies, for different time periods.

Geographies pose the biggest challenge. The aim of this project is to predict performance at ICB geography from the input metrics. The input metrics are published at geographies and locations such as provider trust (including different sites within trusts), STP, CCG, PCT, ICB, Region, Local Authority. Within a metric, the geography can change over time - for example, reporting at CCG changes to ICB when CCGs were abolished.

The next geography challenge is how data published at a smaller geography gets assigned to a larger geography. A simple example is for NHS Provider Trusts. The simple method is to assign the Trust the ICB that the Trust is located within. Undoubtedly, the Trust will be treating patients that reside outside the ICB it is located in, so policies created externally to the Trust will be having an effect on its performance (DISCUSSIONAL POINT).

Frequencies pose a different challenge. Data for the metrics used are published for different frequencies. These are daily, monthly, quarterly and annually (both calendar and financial years). As the modelling is at a high level with the aim to inform long-term planning performing the modelling at an annual basis is optimum. Generally, aggregating higher frequency metrics is a simple process of summing the numerator and the denominator, and then recalculating the metric. For some metrics this is more complicated. For example, the "No Criteria to Reside" metric, which publishes daily figures, provides information on the number of patients in each trust each day that no longer meet the criteria to reside (denominator), and of those patients, the number that remain in hospital (numerator). Aggregating this information up to annual figures by ICB will lose lots of the variation and detail that the daily figures provide, and potentially reduce their usefulness to the modelling.

Finally, time periods provide a challenge. Some metrics begin and end at different times, which makes it more difficult to be able to use them to predict into the future.

### Data description

The metrics collated for the project are described in the table below:

```{r}
#| label: indicator-metadata

meta_table <- read.csv(here::here("data/configuration-table.csv"),
                       encoding = "latin1") |> 
  select("domain", "metric") |> 
  arrange(domain, metric)
  
demand_rows <- grep("Demand", meta_table$domain)
capacity_rows <- grep("Capacity", meta_table$domain)
performance_rows <- grep("Performance", meta_table$domain)

meta_table |> 
  kbl() |> 
  row_spec(demand_rows, color = "white", background = "#AC2572") |> 
  row_spec(capacity_rows, color = "white", background = "#681C66") |> 
  row_spec(performance_rows, color = "white", background = "#BD518F") |> 
  row_spec(0, color = "black") |> 
  scroll_box(height = "300px")
```

The frequencies these metrics have been collected at are displayed below:

```{r}
#| label: data-frequencies
#| fig-height: 12
#| warning: false

all_data <- dc_data |> 
  left_join(
    meta_table,
    by = join_by(metric),
    relationship = "many-to-one"
  ) |> 
  arrange(domain, metric) |> 
  mutate(
    abbreviated_metric = abbreviate(metric, 40),
    abbreviated_metric = factor(
      abbreviated_metric,
      levels = rev(unique(abbreviated_metric))
    )
  )

all_data |> 
  distinct(
    metric, frequency, domain, abbreviated_metric
  ) |> 
  ggplot(
    aes(
      x = frequency,
      y = abbreviated_metric
    )
  ) +
  geom_tile(
    aes(fill = domain)
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(
      angle = 45,
      hjust = 1
    )
  ) +
  labs(
    title = "Metrics and their frequencies within publications",
    y = "Metrics (abbreviated)",
    x = "Frequencies"
  ) +
  scale_fill_manual(
    name = "",
    values = c(
      Demand = "#AC2572",
      Capacity = "#681C66",
      Performance = "#BD518F"
    )
  )


```

For the annual metric (financial year), these are the number of record we have for each year (this is related to the geography the metric is published at):

```{r}
#| label: annual-metric-counts
#| fig-height: 9

all_data |> 
  filter(
    frequency == "annual financial"
  ) |> 
  count(domain, abbreviated_metric, year) |> 
  ggplot(
    aes(
      x = year,
      y = abbreviated_metric
    )
  ) +
  geom_tile(
    aes(fill = n)
  ) +
  theme_minimal() +
  scale_fill_viridis_c(
    name = "Count of records"
  ) +
  labs(
    title = "Count of records by year",
    y = "Metrics (abbreviated)",
    x = "Year"
  ) +
  facet_grid(
    rows = vars(domain),
    scales = "free_y",
    space = "free_y"
  )
```

### Sense check data

The following plots help to understand the data distribution over the years to sense check each year is consistent with previous years.

```{r}
#| label: box-plots
#| warning: false
#| results: 'asis'
#| fig-width: 12
#| fig-height: 15

sense_check <- all_data |> 
  filter(
    grepl("annual", frequency)
  )

boxplot_domains <- function(data) {
  p <- data |> 
    mutate(
      metric = stringr::str_wrap(metric, 30)
    ) |>
    ggplot(
      aes(
        x = as.factor(year),
        y = value
        )
      ) + 
    geom_boxplot() +
    theme_minimal() +
    facet_wrap(
      facets = vars(metric),
      scales = "free"
    ) +
    labs(
      x = "",
      y = ""
    ) +
    theme(
      axis.text.x = element_text(
        angle = 45,
        hjust = 1
      )
    )
  
  return(p)
}

cat("::: {.panel-tabset}\n\n")

for (dom in (unique(sense_check$domain))) {
  cat(paste("##",
          dom,
          "\n\n"))
  
  p <- sense_check |> 
    filter(domain == dom) |> 
    boxplot_domains()
  
  print(p)
  
  cat("\n\n")
}

cat(":::")


```

