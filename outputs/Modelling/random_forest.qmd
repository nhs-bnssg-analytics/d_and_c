---
title: "Random Forest"
order: 3
---

```{r}
#| label: setup
#| message: false

source(here::here("R/00_libraries.R"))
source(here::here("R/01_utils.R"))
source(here::here("R/03_collating_data.R"))
source(here::here("R/04_modelling_utils.R"))
```


## Select fields

```{r}
#| label: field-selection
#| 
target_variable <- "Proportion of completed pathways greater than 18 weeks from referral (admitted)"

dc_data <- dc_data |> 
  select(
    all_of(c("org", "year", target_variable)),
    matches("^ESR|^Workforce|^Bed|age band|Year 6|GPPS")
  ) |> 
  dplyr::filter(
    # retain all rows where target variable is not na
    # retain all rows where we have population age group information
    if_all(
      all_of(
        c(target_variable, "Proportion of population in age band (80-89)")), ~ !is.na(.))
  ) |> 
  arrange(
    year, org
  )
```

## Modelling descriptions and results

### Time series splitting

#### Random forest model with no lagged data

* No lagged data
* selection pattern: `matches("^ESR|^Workforce|^Bed|age band|Year 6|GPPS")`
* data are ordered by time before splitting into train (2013-2018), val (2019) and test (2020)
* impute missing with knn for all predictors

```{r}
#| label: rf-no-lag-ts

rf <-modelling_performance(
  data = dc_data,
  target_variable = target_variable,
  lagged_years = 0, 
  time_series_split = TRUE, 
  model_type = "random_forest", 
  seed = 321 
)

rf$evaluation_metrics

```

#### Random forest model current and lag

* Current year and lagged data (including lagged target variable)
* selection pattern: `matches("^ESR|^Workforce|^Bed|age band|Year 6|GPPS")`
* data are ordered by time before splitting into train (2013-2018), val (2019) and test (2020)
* impute missing with knn for all predictors

```{r}
#| label: rf-lag-and-current-ts

rf <-modelling_performance(
  data = dc_data,
  target_variable = target_variable,
  lagged_years = 1, 
  keep_current = TRUE,
  remove_lag_target = FALSE,
  time_series_split = TRUE, 
  model_type = "random_forest", 
  seed = 321 
)

rf$evaluation_metrics

```

#### Random forest model using only lagged data

* Only lagged data (including lagged target variable)
* selection pattern: `matches("^ESR|^Workforce|^Bed|age band|Year 6|GPPS")`
* data are ordered by time before splitting into train (2014-2018), val (2019) and test (2020)
* impute missing with knn for all predictors

```{r}
#| label: rf-lag-ts

rf <-modelling_performance(
  data = dc_data,
  target_variable = target_variable,
  lagged_years = 1, 
  keep_current = FALSE,
  remove_lag_target = FALSE,
  time_series_split = TRUE, 
  model_type = "random_forest", 
  seed = 321 
)

rf$evaluation_metrics

```

#### Random forest model using only lagged data (without lagged target variable)

* Only lagged data (not including lagged target variable)
* selection pattern: `matches("^ESR|^Workforce|^Bed|age band|Year 6|GPPS")`
* data are ordered by time before splitting into train (2014-2018), val (2019) and test (2020)
* impute missing with knn for all predictors

```{r}
#| label: rf-lag-only-no-target-ts

rf <-modelling_performance(
  data = dc_data,
  target_variable = target_variable,
  lagged_years = 1,
  keep_current = FALSE,
  remove_lag_target = TRUE, 
  time_series_split = TRUE, 
  model_type = "random_forest", 
  seed = 321 
)

rf$evaluation_metrics

```


### Non-time series splitting

#### Random forest model with no lagged data

* No lagged data
* selection pattern: `matches("^ESR|^Workforce|^Bed|age band|Year 6|GPPS")`
* impute missing with knn for all predictors

```{r}
#| label: rf-no-lag

rf <-modelling_performance(
  data = dc_data,
  target_variable = target_variable,
  lagged_years = 0, 
  time_series_split = FALSE, 
  model_type = "random_forest", 
  seed = 321 
)

rf$evaluation_metrics

```

#### Random forest model current and lag

* Current year and lagged data (including lagged target variable)
* selection pattern: `matches("^ESR|^Workforce|^Bed|age band|Year 6|GPPS")`
* impute missing with knn for all predictors

```{r}
#| label: rf-lag-and-current

rf <-modelling_performance(
  data = dc_data,
  target_variable = target_variable,
  lagged_years = 1, 
  keep_current = TRUE,
  remove_lag_target = FALSE,
  time_series_split = FALSE, 
  model_type = "random_forest", 
  seed = 321 
)

rf$evaluation_metrics

```

#### Random forest model using only lagged data

* Only lagged data (including lagged target variable)
* selection pattern: `matches("^ESR|^Workforce|^Bed|age band|Year 6|GPPS")`
* impute missing with knn for all predictors

```{r}
#| label: rf-lag

rf <-modelling_performance(
  data = dc_data,
  target_variable = target_variable,
  lagged_years = 1, 
  keep_current = FALSE,
  remove_lag_target = FALSE,
  time_series_split = FALSE, 
  model_type = "random_forest", 
  seed = 321 
)

rf$evaluation_metrics

```

#### Random forest model using only lagged data (without lagged target variable)

* Only lagged data (not including lagged target variable)
* selection pattern: `matches("^ESR|^Workforce|^Bed|age band|Year 6|GPPS")`
* impute missing with knn for all predictors

```{r}
#| label: rf-lag-only-no-target

rf <-modelling_performance(
  data = dc_data,
  target_variable = target_variable,
  lagged_years = 1,
  keep_current = FALSE,
  remove_lag_target = TRUE, 
  time_series_split = FALSE, 
  model_type = "random_forest", 
  seed = 321 
)

rf$evaluation_metrics

```